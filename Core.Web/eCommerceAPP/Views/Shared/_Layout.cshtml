<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- bootstrap CDN-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
          crossorigin="anonymous">

    <!-- Styles Stylesheet-->

    <link href="~/css/style.css" rel="stylesheet" />


    <!-- Font Awesome JS -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
            crossorigin="anonymous"></script>

    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
          crossorigin="anonymous">


<title>@ViewBag.Title - eCommerce APP</title>
    <style>
        .menu-texto {color: #ffffff !important;}
        table thead tr    {background-color: #dff0d8 !important; color: #3c763d;}
    </style>
</head>
<body class="app">
    @if(User.Identity.IsAuthenticated)
    {
        <input id="alejolbl" hidden="hidden" value="hidden" />
    }
    <div id="loader">
        <div class="spinner"></div>
    </div>
    <div class="wrapper">
        <!-- Sidebar  -->
        <div id="sidebar" @*hidden="hidden"*@>
            <div class="sidebar-header">
                <a class="sidebar-link td-n" href="javascript:void(0);">
                    <div class="logo">
                        <img id="imglogo" src="./images/logo.png">
                        <img id="imglogo2" src="./images/logo21.png">
                    </div>
                </a>
            </div>

            <ul id="navegacion" class="list-unstyled components">
                <li>
                    <a href="#" class="menu-texto">
                        <i class="fas fa-home"></i>
                        <span class="icon-holder">Inicio</span>
                    </a>
                </li>
                <li class="active">
                    <a href="#homeSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <i class="fas fa-user-cog"></i>
                        <span class="icon-holder">Maestros</span>
                    </a>
                    <ul class="collapse list-unstyled" id="homeSubmenu">
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Catálogo de productos</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Centro de costos</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Trasportadoras</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Trazabilidad de Pedidos</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="active">
                    <a href="#homeTransacciones" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        
                        <i class="fas fa-plus"></i>
                        <span class="icon-holder">Transacciones</span>
                    </a>
                    <ul class="collapse list-unstyled" id="homeTransacciones">
                        <li>
                            <a href="/Pedido/Index" class="menu-texto">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="icon-holder">Pedidos</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    @*<a href="#">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="icon-holder">Pedidos</span>
                    </a>*@
                    <a href="#pageSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle menu-texto">
                        <i class="fas fa-address-book"></i>
                        <span class="icon-holder">Administración</span>
                    </a>
                    <ul class="collapse list-unstyled" id="pageSubmenu">
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Roles</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Asignar Roles</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Modulos</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="menu-texto">
                                <i class="fas fa-plus"></i>
                                <span class="icon-holder">Asignar permisos</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:document.getElementById('logoutForm').submit()" class="menu-texto">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="icon-holder">Cerrar sesión</span>
                    </a>
                </li>
            </ul>

        </div>

        <div id="content">

            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">

                    <button type="button" id="sidebarCollapse" onclick="changePic();" class="btn btn-success">
                        <i class="fas fa-bars"></i>
                        <span></span>
                    </button>
                    <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
                            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                            aria-label="Toggle navigation">
                        <i class="fas fa-align-justify"></i>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                
                                    @Html.Partial("_LoginPartial")
                                    @*<i class="fas fa-user"></i>
                                    <span class="icon-holder">Usuario</span>*@
                                
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>



            <main class="main-content">

                @RenderBody()

            </main>
        </div>
    </div>
    <footer class="bdT ta-c p-30 lh-0 fsz-sm">
        <span>
            Desarrollado por <a style="color: #009540" href="https://www.eyesa.com.co" target="_blank">
                EYESA
                S.A
            </a> Administración de Módulos Alternativos.
        </span>
    </footer>


    <!-- Javascript-->
    <!-- jQuery CDN  -->
    @*<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>*@
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    



    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>

    <!-- Bootstrap  -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>

    <script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
            });
            if($('#alejolbl').val())
            {
                $('#navegacion').show();
            }
            else
            {
                $('#sidebar').addClass('active');
                var image = document.getElementById("imglogo");
                var image2 = document.getElementById("imglogo2");
                image.src = "./images/logo21.png";
                image2.src = "./images/logo21.png";
                $('#navegacion').hide();
            }
        });

        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            setTimeout(() => {
                loader.classList.add('fadeOut');
            }, 300);
        });

        function changePic() {
            var image = document.getElementById("imglogo");

            if (image.getAttribute('src') == "./images/logo.png") {
                image.src = "./images/logo21.png";
            } else {
                image.src = "./images/logo.png";
            }
        }

        $(document).ready(function () {
            //AutoComplete Productos
            $("#Nombre_Producto").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "/Pedido/GetProducts",
                        type: "POST",
                        dataType: "json",
                        data: { Prefix: request.term },
                        success: function (data) {
                            response($.map(data, function (item) {
                                return { label: item.Nombre_Producto, value: item.Nombre_Producto, valor: item.ValorNegociado, referencia: item.Referencia, iva: item.PORCENTAJEIVA };
                            }))

                        }
                    })
                },
                select: function(event, ui) {
                    $("#valorProd").val(ui.item.valor);
                    $("#referenciaProd").val(ui.item.referencia);
                    $("#ivaProd").val(ui.item.iva);
                    return true;
                },
                messages: {
                    noResults: "", results: ""
                }
            }).autocomplete("instance")._renderItem = function (ul, item) {
                return $("<li>")
                  .append("<div>" + item.referencia + "<br>" + item.valor + "</div>")
                  .appendTo(ul);
            };;
            //Lista Vendedores
            $("#BODEGA").change(function () {
                $.get("/Pedido/GetVendedores", { idBodega: $("#BODEGA").val() }, function (data) {
                    $("#vendedor").empty();
                    $.each(data, function (index, row) {
                        $("#vendedor").append("<option value='" + row.Vendedor + "'>" + row.vALOR + "</option>")
                    });
                });
                BodegaValida();
                //Limpiar Validacion de Vendedor
                $("#lblVendedor").hide();
                $("#divVendedor").removeClass("has-error");
                
            });
        });

        $("#vendedor").change(function () {
            VendedorValido();
        });

        $("#Nombre_Producto").change(function () {
            ProductoValido();
        });

        $("#cantidadProd").change(function () {
            CantidadValida();
        });

        //Control Fecha
        $(function () {
            $('.date-picker').datepicker();
        })
        //Add row 
        $("body").on("click", "#btnAgregar", function () {

            if (DetalleValido())
            {
                var txtReferencia = $("#referenciaProd");
                var txtNombreProd = $("#Nombre_Producto");
                var txtCantidad = $("#cantidadProd");
                var txtValor = $("#valorProd");
                var txtIva = $("#ivaProd");

                var valorIva = txtValor.val() * (txtIva.val() / 100);
                var subtoal = txtCantidad.val() * txtValor.val();

                var tBody = $("#tblPedidos > TBODY")[0];
                var row = tBody.insertRow(-1);

                //Celda borrar
                var cell = $(row.insertCell(-1));
                //var btnRemove = $("<input />");
                //btnRemove.attr("type", "button");
                //btnRemove.attr("class", "btn btn-link");
                //btnRemove.attr("onclick", "Eliminar(this);");
                //btnRemove.val("Eliminar");
                var spanEliminar = $("<span />");
                spanEliminar.attr("class", "glyphicon glyphicon-trash");
                
                var btnRemove = $("<a />");
                //btnRemove.attr("class", "btn btn-danger btn-sm");
                btnRemove.attr("onclick", "Eliminar(this);");
                btnRemove.attr("title", "Eliminar");
                btnRemove.append(spanEliminar);
                //btnRemove.val("Eliminar");

                cell.append(btnRemove);

                cell = $(row.insertCell(-1));
                cell.html(txtReferencia.val());

                cell = $(row.insertCell(-1));
                cell.html(txtNombreProd.val());

                cell = $(row.insertCell(-1));
                cell.html(txtCantidad.val());

                cell = $(row.insertCell(-1));
                cell.html(txtValor.val());
                

                cell = $(row.insertCell(-1));
                cell.html(valorIva);

                cell = $(row.insertCell(-1));
                cell.html(subtoal);

                txtReferencia.val("");
                txtNombreProd.val("");
                txtCantidad.val("");
                txtValor.val("");
                $("#ivaProd").val("");
                $("#lblTable").hide();

                ContadorTotales();
            }
            
        });
        //Save
        $("body").on("click", "#btnGrabar", function () {

            if (EncabezadoValido())
            {
                var encabezadoDetalle = {};
                encabezadoDetalle.BODEGA = $("#BODEGA").val();
                encabezadoDetalle.vendedor = $("#vendedor").val();
                encabezadoDetalle.fecha = $("#fecha").val();
                encabezadoDetalle.OBSERVACIONES = $("#OBSERVACIONES").val();


                var pedidoDetalle = new Array();

                $("#tblPedidos TBODY TR").each(function () {
                    var row = $(this);
                    var detalle = {};

                    detalle.referencia = row.find("TD").eq(1).html();
                    detalle.descripcion = row.find("TD").eq(2).html();
                    detalle.cantidad = row.find("TD").eq(3).html();
                    detalle.valor = row.find("TD").eq(4).html();
                    detalle.tarifaiva = row.find("TD").eq(5).html();

                    pedidoDetalle.push(detalle);
                });

                encabezadoDetalle.pedidosc2W_2000 = pedidoDetalle;

                //Send the JSON array to Controller using AJAX.
                $.ajax({
                    type: "POST",
                    url: "/Pedido/SavePedido",
                    data: JSON.stringify(encabezadoDetalle),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        //alert(r + " record(s) inserted.");
                        alert("Orden de pedido Registrada.");
                        window.location.href = "/Home/Index";
                    }
                });
            }

            
        });

        //Eliminar Detalle
        function Eliminar(button) {
            //Determine the reference of the Row using the Button.
            var row = $(button).closest("TR");
            //var name = $("TD", row).eq(0).html();
            if (confirm("Desea eliminar este registro?")) {
                //Get the reference of the Table.
                var table = $("#tblPedidos")[0];

                //Delete the Table row using it's Index.
                table.deleteRow(row[0].rowIndex);
            }
        };

        //Validar Encabezado
        function EncabezadoValido() {
            var valido = true;
            
            valido = FechaValida();

            valido = BodegaValida();

            valido = VendedorValido();

            valido = TablaProdValida();

            return valido;
        }

        //Validar Fecha
        function FechaValida() {
            if (!$("#fecha").val()) {
                $("#lblFecha").show();
                $("#divFecha").addClass("has-error");
                return false;
            }
            else {
                $("#lblFecha").hide();
                $("#divFecha").removeClass("has-error");
                return true;
            }
        }

        //Validar Bodega
        function BodegaValida() {
            if (!$("#BODEGA").val()) {
                $("#lblBodega").show();
                $("#divBodega").addClass("has-error");
                return false;
            }
            else {
                $("#lblBodega").hide();
                $("#divBodega").removeClass("has-error");
                return true;
            }
        }

        //Validar Vendedor
        function VendedorValido() {
            if (!$("#vendedor").val()) {
                $("#lblVendedor").show();
                $("#divVendedor").addClass("has-error");
                return false;
            }
            else {
                $("#lblVendedor").hide();
                $("#divVendedor").removeClass("has-error");
                return true;
            }
        }

        //Validar tabla productos
        function TablaProdValida() {
            if ($("#tblPedidos TBODY TR").length == 0) {
                $("#lblTable").show();
                return false;
            }
            else {
                $("#lblTable").hide();
                return true;
            }
        }

        //Validar Detalle
        function DetalleValido() {
            var valido = true;

            valido = ProductoValido();

            valido = CantidadValida();

            return valido;
        }

        //Validar producto
        function ProductoValido()
        {
            if (!$("#Nombre_Producto").val()) {
                $("#lblNomProd").show();
                $("#divNomProd").addClass("has-error");
                return false;
            }
            else {
                $("#lblNomProd").hide();
                $("#divNomProd").removeClass("has-error");
                return true;
            }
        }

        //Validar Cantidad
        function CantidadValida()
        {
            if (!$("#cantidadProd").val()) {
                $("#lblCantProd").show();
                $("#divCantProd").addClass("has-error");
                return false;
            }
            else {
                $("#lblCantProd").hide();
                $("#divCantProd").removeClass("has-error");
                return true;
            }
        }

        function ContadorTotales()
        {
            var subtotal = 0;
            var totalIva = 0;
            var TotalGeneral = 0;
            $("#tblPedidos TBODY TR").each(function () {
                var row = $(this);
                var detalle = {};

                detalle.referencia = row.find("TD").eq(1).html();
                detalle.descripcion = row.find("TD").eq(2).html();
                detalle.cantidad = row.find("TD").eq(3).html();
                detalle.valor = row.find("TD").eq(4).html();
                detalle.Iva = row.find("TD").eq(5).html();
                detalle.subtot = row.find("TD").eq(6).html();

                subtotal = subtotal + parseInt(detalle.subtot);
                totalIva = totalIva + parseFloat(detalle.Iva);
                TotalGeneral = TotalGeneral + (subtotal + totalIva);

            });
            $("#lblSubTotal").text(formatoMoneda(subtotal));
            $("#lblTotalIva").text(formatoMoneda(totalIva.toFixed(2)));
            $("#lblTotGeneral").text(formatoMoneda(TotalGeneral));
        }

        //Formato Tipo Moneda
        function formatoMoneda(number) {
            
            var input_val = "";
            input_val = number + "";

            if (input_val === "") { return; }

            var original_len = input_val.length;

            if (input_val.indexOf(".") >= 0) {

                var decimal_pos = input_val.indexOf(".");

                var left_side = input_val.substring(0, decimal_pos);
                var right_side = input_val.substring(decimal_pos);

                left_side = formato(left_side);

                right_side = formato(right_side);

                right_side = right_side.substring(0, 2);

                input_val = "$" + left_side + "," + right_side;

            } else {
                input_val = formato(input_val);
                input_val = "$" + input_val;
            }
            return input_val;
        }
        //Helper para formato
        function formato(n) {
            return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".")
        }

    </script>


   
    @RenderSection("scripts", required: false)
</body>
</html>
